---
title: "VAST Challenge 2021: Mini Challenge 2: "
description: |
  We are asked to analyze movement and tracking data of GAStech employees to identity anomolies and suspicious behaviour.
author:
  - name: HONG Yun Ting
    url: {}
date: 07-01-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Overview
GAStech is a company that is located in a country island of Kronos and it has come to their attention that some of the employees had mysteriously went missing. Vehicles tracking data that was secretly installed in the company's cars and Kronos-Kares benefit card information are delivered to authorities for investigation. 

# Literature review of existing analysis performed

# 3. Extracting, wrangling and preparing the input data

### 3.1 Setting up environment
```{r, echo=TRUE}
packages = c('tidyverse', 'lubridate', 'dplyr', 'raster', 'clock', 'sf', 'tmap', 'plotly', 'ggplot2', 'mapview', 'rgdal',
             'rgeos', 'tidyr')

for (p in packages) {
  if (!require(p, character.only = T)) {
    install.packages(p, repos = "http://cran.us.r-project.org")
  }
  library(p, character.only = T)
}
```

## Importing Employee's Info and Car Assignment
```{r, echo = TRUE}
carAssignment <- read_csv("mc2/car-assignments.csv") 
carAssignment
```

## Import Credit card and Loyalty card data
```{r, echo=TRUE}
ccData <- read_csv("MC2/cc_data.csv")
ccData$timestamp = date_time_parse(ccData$timestamp, zone = "", format = "%m/%d/%Y %H:%M")

ccData <- ccData %>%
  mutate(date = as.Date(timestamp), time = strftime(timestamp, "%H:%M"), hr = strftime(timestamp, "%H"))


loyaltyData <- read_csv("MC2/loyalty_data.csv") %>%
  mutate(date = as.Date(mdy(timestamp)))


ccLoyalty <- left_join(ccData, loyaltyData, by = c("date", "location", "price")) %>%
  dplyr::select(date, time, location, price, last4ccnum, loyaltynum, hr) %>%
  group_by(last4ccnum)

ccLoyalty$weekday = wday(ccLoyalty$date, label = TRUE, abbr = TRUE) 
ccLoyalty$last4ccnum = as.character(ccLoyalty$last4ccnum)

ccLoyalty
```

```{r}
ccLoyalty_person <- ccLoyalty %>% 
    group_by(last4ccnum) %>%
    distinct(loyaltynum) %>%
    arrange(last4ccnum) %>%
  filter(loyaltynum != 'NA')
ccLoyalty_person


ccLoyalty_person$ccPerson <- ccLoyalty_person %>% group_indices(last4ccnum)
ccLoyalty_person
```

```{r}
lcard <- ccLoyalty %>% 
    group_by(loyaltynum) %>%
    distinct(last4ccnum) %>%
    arrange(loyaltynum)

```

```{r}

new <- merge(ccLoyalty_person, lcard, by="loyaltynum")
new %>%
  arrange(ccPerson)

lookup <- new %>%
  select(ccPerson, last4ccnum.y) %>%
  arrange(ccPerson) %>%
  distinct(last4ccnum.y, .keep_all = TRUE)

#lookup %>%
#  distinct(last4ccnum.y, .keep_all = TRUE)
```

```{r}
 
lookup
xdata <- inner_join(new, lookup, by=c("ccPerson", "last4ccnum.y"))
xdata %>% arrange(ccPerson)

```

# Mapping credit cards and loyalty card to same person
1 employee can carries multiple credit cards and loyalty cards
```{r}
ccLoyalty_merge = left_join(ccLoyalty, xdata, by=c("last4ccnum"="last4ccnum.y")) %>%
  select(ccPerson, weekday, date, time, location, price, last4ccnum, loyaltynum.x) %>%
  arrange(ccPerson) %>%
  distinct()
ccLoyalty_merge 
```

```{r}
new2 <- new

new2 %>% filter(last4ccnum.x == last4ccnum.y)

new2$ccPerson <- ifelse(new$loyaltynum == new2$loyaltynum &
                          (new$last4ccnum.x == new2$last4ccnum.y | new$last4ccnum.y == new2$last4ccnum.y) &
                          new$ccPerson != new2$ccPerson
                          ,new$ccPerson, new2$ccPerson)

data1 <- new2 %>% arrange(ccPerson)

```

# Swap
```{r}



```

## Importing GPS 
1. Converting Timestamp to "Year-Month-Day Hour:Minutes" (YYYY-MM-DD HH:MM) format
2. Separate Timestamp into 2 new columns (Date & Time) 
3. Converting data type for id to factor 

```{r, echo=TRUE}

gps <- read_csv("MC2/gps.csv") %>%
  mutate(date = as.Date(mdy_hms(Timestamp)), time = format(mdy_hms(Timestamp), "%H:%M"))

gps$Timestamp <- date_time_parse(gps$Timestamp, zone = "", format = "%m/%d/%Y %H:%M:%S")  
gps$hr <- strftime(gps$Timestamp, "%H")
gps$id <- as_factor(gps$id)
gps$weekday = wday(gps$date, label = TRUE, abbr = TRUE) 

gps
```

## Car coordinates when vehicle stopped
I am eliminating coordinates that indicating that the car is moving
The GPS car coordinates are recorded every 1-5 secs. 
Therefore, if there is a GPS record difference of more than 5 min, which means the employee has driven the car to a destination.
Thus this eliminates possible traffic light stops and car moving in motion data.

For each employee:
1. I am getting the first and last car coordinate each day 
2. Getting places of interest through the day

```{r, echo=TRUE}
ts <- gps %>%
  group_by(id) %>%
    arrange(date, time, by_group=TRUE) %>%
      mutate(diff = round(c(difftime(tail(Timestamp, -1), head(Timestamp, -1), units = "mins"), 0)), 2) %>%
      mutate(count = 1:n(), FIRST = count == 1, LAST = count == max(count)) %>%
        filter(diff > 5 | FIRST == TRUE | LAST == TRUE) %>%
  arrange(id) %>%
  select(id, lat, long, date, time, diff, hr, weekday)

ts
```

# Compare GPS to credit card
```{r}

test_gps_date <- '2014-01-06'

selected_gps_field <- ts %>%
  filter(date == test_gps_date)

cc_id <- left_join(selected_gps_field, ccLoyalty, by=c("date" = "date", "hr" = "hr")) 
#%>% select(id, diff, location, last4ccnum, loyaltyData)
cc_id
```

```{r}

gps_id1 <- gps %>%
  filter(id == 1)

map <- ggplot() + 
    geom_point(data = gps_id1, aes(x = long, y = lat)) + # Add coordinate data
    theme_bw() + # Change the plot theme
    ggtitle("Employee 1's Journey") + # Give the plot a title
    xlab("Longitude") + # Change x axis title
    ylab("Latitude") # Change y axis title
```

```{r}
bgmap <- raster("MC2/Geospatial/MC2-tourist_modified.tif")
bgmap # raster layer

tm_shape(bgmap) + # full data of the spatial file
  tm_raster(bgmap, legend.show = FALSE)
```

```{r}
#Abila_st <- st_read("MC2/Geospatial", layer = "Abila") # store it as simple feature
#Abila_st
Abila_st <- readOGR("MC2/Geospatial", layer = "Abila")
Abila_st
```

```{r}
gps_sf_path <- st_as_sf(ts, coords = c("long", "lat"), crs = 4326)  %>%
            #group_by(id) %>%
            #summarize(Timestamp = mean(Timestamp),
            #             do_union=FALSE) %>% #Summarize is unless, but because we want to use group_by, we need to do something
            st_cast("POINT")
```

# Map view of Abila, Kronos's route and Employees' whereabout

```{r, echo=TRUE}
tmap_mode("view")
tm_shape(bgmap) + 
  tm_rgb(bgmap, r = 1, g = 2, b = 3, # setting red to band 1, green to band 2, blue to band 3
         alpha = NA,
         saturation = 1,
         interpolate = TRUE, 
         max.value = 255) +
  tmap_options(max.categories = 44) +
  tm_shape(Abila_st) + 
    tm_lines() +
  tm_shape(gps_sf_path) +
    tm_dots(col ="id",
            popup.vars=c("Date:"="date", "Time:"="time", "Week:"="weekday"))

```




## Storing location coordinates

```{r, echo=TRUE}

  
id <- c("1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35")

location <- c("Brew've Been Served","Hallowed Grounds","Brew've Been Served","Coffee Cameleon","Abila Airport","Kronos Pipe and Irrigation","Nationwide Refinery","Maximum Iron and Steel","Stewart and Sons Fabrication","Carlyle Chemical Inc.","Coffee Shack","Bean There Done That","Brewed Awakenings","Jack's Magical Beans","Katerinaís CafÈ","Hippokampos","Abila Zacharo","Gelatogalore","Kalami Kafenion","Ouzeri Elian","Guy's Gyros","U-Pump","Frydos Autosupply n' More","Albert's Fine Clothing","Shoppers' Delight","Abila Scrapyard","Frank's Fuel","Chostus Hotel","General Grocer","Kronos Mart","Octavio's Office Supplies","Roberts and Sons","Ahaggo Museum","Desafio Golf Course","Daily Dealz", "GAStech")


#lat <- c(23, 41, 32, 58, 26)
#long <-
desc <- c("Calixto Nils's house","Azada Lars's house","Balas Felix's house","Barranco Ingrid's house","Baza Isak's house","Bergen Linnea's house","Orilla Elsa's house","Alcazar Lucas's house","Cazar Gustav's house","Campo-Corrente Ada's house","Calzas Axel's house","Cocinaro Hideki's house","Ferro Inga's house","Dedos Lidelse's house","Bodrogi Loreto's house","Vann Isia's house","Flecha Sven's house","Frente Birgitta's house","Frente Vira's house","Fusil Stenig's house","Osvaldo Hennie's house","Nubarron Adra's house","Lagos Varja's house","Mies Minke's house","Herrero Kanon's house","Onda Marin's house","Orilla Kare's house","Borrasca Isande's house","Ovan Bertrand's house","Resumir Felix's house","Sanjorge Jr. Sten's house","Strum Orhan's house","Tempestad Brand's house","Vann Edvard's house","Vasco-Pais Willem's house")
  

df <- data.frame(id, desc)
df
```

